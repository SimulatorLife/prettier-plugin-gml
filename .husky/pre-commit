#!/usr/bin/env sh
# husky pre-commit hook to format and lint code before committing.

if [ -z "${BASH_VERSION:-}" ]; then
	# Husky launches hooks with sh; re-exec under bash so nvm/formatter logic runs consistently.
	exec bash "$0" "$@"
fi

set -euo pipefail

repo_root="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$repo_root"

# Display current Node and npm versions
echo "Node: $(node -v)"
echo "npm:  $(npm -v)"

# Collect staged files so we can target format/lint runs
tmp_staged_list="$(mktemp)"
trap 'rm -f "$tmp_staged_list"' EXIT
git diff --cached --name-only --diff-filter=ACMR -z > "$tmp_staged_list"

staged_files=()
while IFS= read -r -d '' file; do
	staged_files+=("$file")
done < "$tmp_staged_list"

if [ "${#staged_files[@]}" -eq 0 ]; then
	echo "No staged files to check; skipping format/lint."
	exit 0
fi

prettier_targets=()
eslint_targets=()
for file in "${staged_files[@]}"; do
	case "$file" in
		*.ts|*.js|*.cjs|*.mjs)
			prettier_targets+=("$file")
			eslint_targets+=("$file")
			;;
	esac
done

if [ "${#prettier_targets[@]}" -eq 0 ] && [ "${#eslint_targets[@]}" -eq 0 ]; then
	echo "No staged TypeScript sources to format or lint; skipping."
	exit 0
fi

files_to_restage=()

if [ "${#prettier_targets[@]}" -gt 0 ]; then
	echo "Formatting staged TypeScript files with Prettier..."
	npm exec -- prettier --ignore-path ./.prettierignore --write "${prettier_targets[@]}"
	files_to_restage+=("${prettier_targets[@]}")
fi

if [ "${#eslint_targets[@]}" -gt 0 ]; then
	echo "Linting staged TypeScript files with ESLint..."
	npm exec -- eslint --cache --fix "${eslint_targets[@]}"
	files_to_restage+=("${eslint_targets[@]}")
fi

if [ "${#files_to_restage[@]}" -gt 0 ]; then
	git add -- "${files_to_restage[@]}"
fi

echo "Pre-commit checks limited to staged TypeScript sources."