#!/usr/bin/env sh
set -e

# Load nvm if present
export NVM_DIR="${NVM_DIR:-$HOME/.nvm}"
if [ -s "$NVM_DIR/nvm.sh" ]; then
  # shellcheck source=/dev/null
  . "$NVM_DIR/nvm.sh"
else
  echo "⚠️  nvm not found at $NVM_DIR. Using system Node ($(node -v 2>/dev/null || echo none))."
fi

# Use version from .nvmrc if nvm is available
if command -v nvm >/dev/null 2>&1; then
  if [ -f ".nvmrc" ]; then
    nvm use --silent >/dev/null 2>&1 || nvm install >/dev/null
  else
    echo "ℹ️  No .nvmrc found; using current Node ($(node -v))."
  fi
fi

echo "Node: $(node -v)"
echo "npm:  $(npm -v)"

# Run format then lint (format first so lint --fix has less to do)
npm run format
npm run lint:fix

# Re-stage only modified tracked files in case formatters rewrote them
git add -u