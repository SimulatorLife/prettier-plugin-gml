# Identifier case rollout

This guide expands on the high-level steps from the README and explains how the
project-index bootstrap works now that the formatter can auto-discover your
GameMaker project. Use it as a reference when rolling identifier-case features
out to a team or when you need deterministic CI behaviour. The companion
[identifier-case scope reference](./identifier-case-reference.md) describes how
each scope is planned and the safety checks enforced before renames are
applied.

## Automatic project index bootstrap

- When `gmlIdentifierCase` (or any scope override) enables renaming, the parser
  looks for a `.yyp` manifest starting from the file being formatted and walking
  up towards the filesystem root.
- Once a manifest is found the formatter loads
  `.prettier-plugin-gml/project-index-cache.json`. If the cache is missing or
  stale the formatter rebuilds the index, logs metrics, and writes an updated
  snapshot to that path.
- The bootstrap result is stored on the Prettier options object so tests and
  editor integrations can inspect whether the index came from a build or a cache
  hit (`options.__identifierCaseProjectIndexBootstrap.source`).

The cache keeps identifier-case formatting fast across large projects and gives
both the CLI and editor integrations consistent rename plans.

## Configuration switches

| Option | Purpose |
| --- | --- |
| `gmlIdentifierCaseProjectRoot` | Points the bootstrap at a specific GameMaker project directory. Use this when formatting files that live outside the project tree, or when you want a CI run to pin to a known project root. |
| `gmlIdentifierCaseDiscoverProject` | Set to `false` to disable discovery entirely. This is useful when you provide `identifierCaseProjectIndex` manually or want to gate index creation behind a custom script. |
| `identifierCaseProjectIndex` | Existing escape hatch that bypasses the bootstrap. Provide a JSON index generated by your build to make the plan deterministic across machines. |
| `gmlIdentifierCaseAcknowledgeAssetRenames` | Required when `gmlIdentifierCaseAssets` leaves observation mode. Signals that file-system renames and `.yy` updates are expected during the rollout. |
| `gmlIdentifierCaseProjectIndexCacheMaxBytes` | Caps the on-disk cache payload (default `8 MiB`, overridable via `GML_PROJECT_INDEX_CACHE_MAX_SIZE`). Increase the limit when large projects evict entries too aggressively. |
| `gmlIdentifierCaseProjectIndexConcurrency` | Controls how many GameMaker sources are parsed in parallel while building the index (default `4`, overridable via `GML_PROJECT_INDEX_CONCURRENCY`). Tune this if CI machines have fewer cores or stricter CPU quotas. |
| `gmlIdentifierCaseOptionStoreMaxEntries` | Bounds how many identifier-case option snapshots the formatter keeps alive. Set to `0` to disable eviction for deep audits. |

Refer to the [main README](../README.md#plugin-specific-options) for the full
option matrix, including scope overrides such as `gmlIdentifierCaseGlobals` and
reporting hooks like `identifierCaseReportLogPath`.

## Asset rename acknowledgements

- When you enable the `assets` scope (either via `gmlIdentifierCase` or
  `gmlIdentifierCaseAssets`), set
  `gmlIdentifierCaseAcknowledgeAssetRenames: true` in the same configuration
  block. This unlocks rename operations that touch `.yy` files and physical
  asset directories.
- Dry-run the plan with `identifierCaseDryRun: true` and capture the report to a
  file with `identifierCaseReportLogPath` before allowing writes. The report
  lists every asset rename plus any conflicts that require manual clean-up.
- Keep backups or version-control checkpoints handy—the formatter will move
  files on disk once acknowledgements are in place.

All switches can be used from `.prettierrc` files, CLI overrides, or programmatic
consumers. They can also be combined—for example, you can disable discovery but
still provide `gmlIdentifierCaseProjectRoot` for downstream tooling that expects
it.

## Cache lifecycle and hygiene

- Cache entries live under `PROJECT/.prettier-plugin-gml/project-index-cache.json`.
- The cache key includes the formatter version, plugin version, manifest mtimes,
  and the mtimes for any GML sources involved in the plan. Changing any of those
  invalidates the cache automatically.
- Delete the `.prettier-plugin-gml` directory if you want to force a rebuild on
  the next formatter run.
- The bootstrap returns `{ status: "ready", source: "cache" }` when a cached
  index is reused. Use this to assert cache behaviour in tests.

## Manual snapshots and deterministic CI

Automatic discovery removes the need to generate `.gml-reports/project-index.json`
for everyday formatting, but you can still keep manual snapshots for audit
purposes:

1. Use the scripted example in
   [`docs/examples/identifier-case/locals-first.prettierrc.mjs`](./examples/identifier-case/locals-first.prettierrc.mjs)
   or call `buildProjectIndex(projectRoot)` directly to generate a manual index.
2. Commit the JSON alongside your branch or store it as a CI artifact.
3. Pass the file via `identifierCaseProjectIndex` to force the formatter to use
   the exact snapshot instead of the live bootstrap.

## Troubleshooting checklist

- Formatter still reports "project-root-not-found"? Double-check the file path
  passed to Prettier and confirm a `.yyp` manifest exists in a parent directory.
- Running on generated output or vendor code? Disable discovery with
  `gmlIdentifierCaseDiscoverProject: false` so the formatter skips bootstrap
  work.
- Need to log cache behaviour? Enable `logIdentifierCaseMetrics` and inspect the
  emitted counters; bootstrap hits/misses are recorded alongside the rest of the
  identifier-case metrics.

Reach out on the issue tracker if you need additional hooks for bespoke build
pipelines—the bootstrap helper is designed to support both automated and manual
rollout strategies.
