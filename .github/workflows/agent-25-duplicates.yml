name: "Agent 25 - Duplicate Lint"
on:
  workflow_dispatch:
    inputs:
      agent:
        description: "Optional agent override."
        required: false
        default: ""
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check_duplicates:
    runs-on: ubuntu-latest
    outputs:
      duplicates_found: ${{ steps.run_duplicates.outputs.duplicates_found }}
      duplicates_output: ${{ steps.run_duplicates.outputs.duplicates_output }}
    steps:
      - uses: actions/checkout@v4

      - name: Read Node version from .nvmrc
        id: read-node-version
        run: echo "version=$(cat .nvmrc)" >> "$GITHUB_OUTPUT"

      - name: Enable pnpm via Corepack
        run: |
          corepack enable
          corepack prepare pnpm@9.0.0 --activate

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ steps.read-node-version.outputs.version }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run duplicate scan
        id: run_duplicates
        run: |
          set +e
          output="$(pnpm run lint:duplicates 2>&1)"
          if echo "$output" | grep -qiE "found[[:space:]]+[1-9][0-9]*[[:space:]]+clones" \
            || echo "$output" | grep -qiE "clones?[[:space:]]+found:[[:space:]]*[1-9][0-9]*" \
            || echo "$output" | grep -qiE "clones found[[:space:]]+[1-9][0-9]*"; then
            found="true"
          else
            found="false"
          fi
          delimiter="EOF_$(date +%s%N)"
          {
            echo "duplicates_found=$found"
            echo "duplicates_output<<$delimiter"
            printf '%s\n' "$output"
            echo "$delimiter"
          } >> "$GITHUB_OUTPUT"
          exit 0

  run:
    needs: check_duplicates
    if: ${{ needs.check_duplicates.outputs.duplicates_found == 'true' }}
    uses: ./.github/workflows/_agent-open-pr-and-ping.yml
    secrets: inherit
    with:
      agent: ${{ inputs.agent }}
      pr_title: "Agent: Resolve Duplicate Code"
      prompt: >
        Run `pnpm run lint:duplicates` and use the output below as your starting context.
        Address/de-dupe the duplicated code identified in the duplicates report
        Focus on one tight cluster at a time and avoid unrelated refactors. Eliminate the
        duplication by consolidating logic into a shared helper, reusing an existing helper,
        or otherwise making a targeted refactor that removes the repeated code. Keep the
        change minimal, well-named, and aligned with existing domain boundaries. Once you
        have addressed the duplicates, re-run `pnpm run lint:duplicates` to confirm that
        the reported duplicates are resolved and the output no longer shows those matches.
        Include a short summary of what was de-duplicated and where the shared logic now lives.

        Duplicate output:
        ```
        ${{ needs.check_duplicates.outputs.duplicates_output }}
        ```
