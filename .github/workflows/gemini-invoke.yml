name: '▶️ Gemini Invoke'

on:
  issue_comment:
    types: [created]

concurrency:
  group: '${{ github.workflow }}-invoke-${{ github.event_name }}-${{ github.event.issue.number }}'
  cancel-in-progress: false

defaults:
  run:
    shell: 'bash'


jobs:

  prepare:
    if: ${{ github.event.issue.pull_request && contains(github.event.comment.body || '', '@gemini') }}
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.set_pr.outputs.pr_number }}
      additional_context: ${{ steps.set_pr.outputs.additional_context }}
      api_key: ${{ steps.pick_key.outputs.api_key }}
    steps:
      - name: Set PR metadata
        id: set_pr
        shell: bash
        run: |
          set -euo pipefail
          # Pass the raw event values through to the parent workflow; parent will validate mention and fetch PR meta
          echo "pr_number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          echo "additional_context<<EOF" >> "$GITHUB_OUTPUT"
          printf '%s' "${{ github.event.comment.body }}" >> "$GITHUB_OUTPUT"
          echo >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Pick API key
        id: pick_key
        shell: bash
        run: |
          set -euo pipefail
          key_num=$((1 + RANDOM % 5))
          case $key_num in
            1) selected="${{ secrets.GEMINI_API_KEY }}" ;;
            2) selected="${{ secrets.GEMINI_API_KEY2 }}" ;;
            3) selected="${{ secrets.GEMINI_API_KEY3 }}" ;;
            4) selected="${{ secrets.GEMINI_API_KEY4 }}" ;;
            5) selected="${{ secrets.GEMINI_API_KEY5 }}" ;;
          esac
          echo "api_key=${selected}" >> "$GITHUB_OUTPUT"

      - name: Install gemini CLI
        run: |
          if ! command -v gemini >/dev/null 2>&1; then
            npm install -g @google/gemini-cli@latest
          fi
  
  invoke:
    needs: prepare
    uses: ./.github/workflows/agent-invoke.yml
    secrets: inherit
    with:
      pr_number: ${{ needs.prepare.outputs.pr_number }}
      additional_context: ${{ needs.prepare.outputs.additional_context }}
      agent: gemini
      settings_json: |
        { "model": { "maxSessionTurns": 35 } }
      agent_command: |
        set -euo pipefail
        if ! command -v gemini >/dev/null 2>&1; then
          npm install -g @google/gemini-cli@latest
        fi

        # Write settings to a file (the parent already exposes $RUNNER_TEMP)
        echo '${{ inputs.settings_json }}' > "$RUNNER_TEMP/.gemini/settings.json"

        # Optional: export path for Gemini CLI to use
        export GEMINI_CLI_SYSTEM_SETTINGS_PATH="$RUNNER_TEMP/.gemini/settings.json"

        echo "Running gemini CLI..."
        gemini ${{ inputs.additional_context }}