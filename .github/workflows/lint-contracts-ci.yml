name: Lint Contracts CI

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  lint-contracts:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        eslint-version: ["9.39.0", "^9"]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10.29.3
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Pin ESLint version for matrix
        run: pnpm add -Dw "eslint@${{ matrix.eslint-version }}"

      - name: Build workspaces
        run: pnpm run build:ts

      - name: Lint workspace contract and integration tests
        run: pnpm run test:lint

      - name: Dependency boundary policy checks
        run: pnpm run check:dependency-policy

      - name: Generate project-aware rule docs
        run: pnpm run generate:lint-rule-docs

      - name: Ensure generated project-aware rule docs are committed
        run: git diff --exit-code -- docs/generated/project-aware-rules.md

  cli-nested-consumer:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10.29.3
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build CLI
        run: pnpm --filter @gml-modules/cli run build:types

      - name: Verify CLI in nested node_modules consumer layout
        run: |
          mkdir -p tmp-consumer/apps/demo/node_modules
          ln -s "$GITHUB_WORKSPACE" tmp-consumer/apps/demo/node_modules/root
          cd tmp-consumer/apps/demo
          node ./node_modules/root/src/cli/dist/index.js lint --help
