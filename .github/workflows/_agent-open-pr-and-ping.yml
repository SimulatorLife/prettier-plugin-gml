name: "Agent - Open PR and Ping"

on:
  workflow_call:
    inputs:
      pr_title:
        required: true
        type: string
      prompt:
        required: true
        type: string
      base_branch:
        required: false
        type: string
        default: "main"
      author_name:
        required: false
        type: string
        default: ${{ vars.GH_USER_NAME }}
      author_email:
        required: false
        type: string
        default: ${{ vars.GH_USER_EMAIL }}
      agent:
        required: false
        type: string
        default: ""  # Optional override; blank => weighted random selection
    outputs:
      pr_number:
        value: ${{ jobs.open_and_ping.outputs.pr_number }}
      branch:
        value: ${{ jobs.open_and_ping.outputs.branch }}

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  open_and_ping:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ fromJSON(steps.pr.outputs.result).number }}
      branch: ${{ env.BRANCH_NAME }}
    env:
      BASE_BRANCH: ${{ inputs.base_branch }}
      REQUESTED_AGENT: ${{ inputs.agent }}
      BRANCH_SUFFIX: ${{ format('task-{0}-{1}', github.run_id, github.run_attempt) }}
      AGENT: ${{ inputs.agent }}
      BRANCH_NAME: ""

    steps:
      - name: Validate GH_USER_TOKEN
        run: |
          set -e
          test -n "${GH_USER_TOKEN}" || { echo "GH_USER_TOKEN is empty"; exit 1; }
          code=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${GH_USER_TOKEN}" https://api.github.com/user)
          if [ "$code" != "200" ]; then
            echo "Token cannot access /user (HTTP $code). Check scopes, repo access, and SSO."; exit 1;
          fi
        env:
          GH_USER_TOKEN: ${{ secrets.GH_USER_TOKEN }}

      - name: Checkout (with your token so pushes are yours)
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base_branch }}
          fetch-depth: 0
          token: ${{ secrets.GH_USER_TOKEN }}

      - name: Select agent (weighted random)
        id: select_agent
        uses: actions/github-script@v7
        env:
          REQUESTED_AGENT: ${{ env.REQUESTED_AGENT }}
          BRANCH_SUFFIX: ${{ env.BRANCH_SUFFIX }}
          WEIGHTS_PATH: .github/workflows/weights.json
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const crypto = require('crypto');

            const DEFAULT_AGENT = 'copilot';

            const normalize = (value) => {
              const trimmed = (value || '').trim();
              if (!trimmed) return '';
              return trimmed
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '')
                || '';
            };

            const ensureBranchSuffix = () => {
              const fromEnv = (process.env.BRANCH_SUFFIX || '').trim();
              if (fromEnv) return fromEnv;
              return `task-${Date.now()}`;
            };

            const chooseWeighted = (items) => {
              const total = items.reduce((sum, item) => sum + item.weight, 0);
              if (!Number.isFinite(total) || total <= 0) return null;

              const random = parseInt(crypto.randomBytes(6).toString('hex'), 16) / 0xFFFFFFFFFFFF;
              let threshold = random * total;
              for (const item of items) {
                threshold -= item.weight;
                if (threshold <= 0) {
                  return { ...item, random, total };
                }
              }
              return { ...items[items.length - 1], random, total };
            };

            const requested = normalize(process.env.REQUESTED_AGENT);
            const suffix = ensureBranchSuffix();

            const finalize = (agent, reason) => {
              const agentSlug = agent;
              const branchName = `${agentSlug}/${suffix}`;

              core.info(`Using agent "${agentSlug}" (${reason}). Branch name: ${branchName}`);

              core.exportVariable('AGENT', agentSlug);
              core.exportVariable('BRANCH_NAME', branchName);
              core.setOutput('agent', agentSlug);
              core.setOutput('branch', branchName);
            };

            if (requested) {
              finalize(requested, 'manual override');
              return;
            }

            let candidates = [];
            try {
              const weightsPath = path.resolve(process.cwd(), process.env.WEIGHTS_PATH || '.github/workflows/weights.json');
              const raw = fs.readFileSync(weightsPath, 'utf8');
              const parsed = JSON.parse(raw);
              if (Array.isArray(parsed?.agents)) {
                candidates = parsed.agents
                  .map((agent) => ({
                    name: typeof agent?.name === 'string' ? agent.name : '',
                    weight: Number(agent?.weight),
                  }))
                  .filter((agent) => agent.name && Number.isFinite(agent.weight) && agent.weight > 0)
                  .map((agent) => ({
                    name: agent.name,
                    weight: agent.weight,
                    slug: normalize(agent.name),
                  }))
                  .filter((agent) => agent.slug);
              }
            } catch (error) {
              core.warning(`Falling back to default agent due to configuration error: ${error.message}`);
            }

            if (!candidates.length) {
              finalize(DEFAULT_AGENT, 'default fallback');
              return;
            }

            const chosen = chooseWeighted(candidates);
            if (!chosen) {
              finalize(DEFAULT_AGENT, 'weighted selection fallback');
              return;
            }

            const { slug, name, weight, random, total } = chosen;
            core.info(`Random draw ${random.toFixed(6)} selected agent "${name}" (slug=${slug}, weight=${weight}) from total weight ${total.toFixed(6)}.`);
            finalize(slug, 'weighted selection');

      - name: Create empty commit on new branch (from latest base)
        run: |
          # Prefer user-provided identity; otherwise leave Git defaults (will still push with your PAT)
          if [ -n "${AUTHOR_NAME}" ]; then git config user.name  "${AUTHOR_NAME}"; fi
          if [ -n "${AUTHOR_EMAIL}" ]; then git config user.email "${AUTHOR_EMAIL}"; fi

          git fetch origin "$BASE_BRANCH"
          git switch -c "$BRANCH_NAME" "origin/$BASE_BRANCH"

          git commit --allow-empty -m "${{ inputs.pr_title }}"
          git push -u origin "$BRANCH_NAME"
        env:
          BASE_BRANCH: ${{ inputs.base_branch }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
          AUTHOR_NAME: ${{ inputs.author_name }}
          AUTHOR_EMAIL: ${{ inputs.author_email }}

      - name: Open PR (authored by your user)
        id: pr
        uses: actions/github-script@v7
        env:
          PR_TITLE: ${{ inputs.pr_title }}
          PROMPT: ${{ inputs.prompt }}
          BASE_BRANCH: ${{ inputs.base_branch }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
          STANDARD_BODY: "Seed PR to request agent to implement a requested improvement."
        with:
          github-token: ${{ secrets.GH_USER_TOKEN }}
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              title: process.env.PR_TITLE,
              head:  process.env.BRANCH_NAME,
              base:  process.env.BASE_BRANCH,
              body:  process.env.STANDARD_BODY,
              maintainer_can_modify: true,
            });
            return {
              number: pr.number,
              head_sha: pr.head.sha,
            };

      - name: (Optional) Label the PR (as your user)
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ fromJSON(steps.pr.outputs.result).number }}
          AGENT: ${{ env.AGENT }}
        with:
          github-token: ${{ secrets.GH_USER_TOKEN }}
          script: |
            try {
              const agent = ((process.env.AGENT || '').trim() || 'copilot').toLowerCase();
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: Number(process.env.ISSUE_NUMBER),
                labels: [agent],
              });
            } catch (e) {
              core.info('Label add skipped: ' + e.message);
            }

      - name: Comment to trigger AI agent (as your user)
        uses: actions/github-script@v7
        env:
          BASE_BRANCH: ${{ inputs.base_branch }}
          PROMPT: ${{ inputs.prompt }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
          PR_NUMBER: ${{ fromJSON(steps.pr.outputs.result).number }}
          HEAD_SHA: ${{ fromJSON(steps.pr.outputs.result).head_sha }}
          AGENT: ${{ env.AGENT }}
        with:
          github-token: ${{ secrets.GH_USER_TOKEN }}
          script: |
            const prNumber = Number(process.env.PR_NUMBER);
            const owner  = context.repo.owner;
            const repo   = context.repo.repo;
            const branch = process.env.BRANCH_NAME;
            const agent = (process.env.AGENT || '').trim() || 'copilot';
            const mention = `@${agent}`;

            const preInstruction = "Begin by surveying the entire codebase before narrowing to this task.";
            const postInstruction = "Ensure changes are self-contained, tested, and documented as needed, with no reduction in test coverage. Ensure the diff is minimal, readable, and well-commented; never sacrifice clarity for cleverness. There is no time constraint or specific allotted time for this task; prioritize quality and correctness over speed and take as much time as needed. You may **NOT** respond with \"no issues found\", \"didn't find any major issues\", or similarâ€”if no obvious implementation exists, choose the most plausible area and apply a singular, safe, minimal improvement.";
            const lines = [
              `${mention} ${preInstruction} ${process.env.PROMPT} ${postInstruction}`,
              ""
            ];

            if (agent === 'codex') {
              lines.push(
                `Once done, ensure all changes are pushed to remote branch **${branch}** on base **${process.env.BASE_BRANCH}** and keep all commits tied to PR #${prNumber}; do not open new branches or PRs. As the final step (even after running 'make_pr'), run the following exact command(s) to guarantee your changes are pushed:`,
                "",
                "```bash",
                `git push "https://github.com/${owner}/${repo}.git" "HEAD:${branch}"`,
                "```",
                ""
              );
            }

            const body = lines.join("\n");

            await github.rest.issues.createComment({ 
              owner, 
              repo, 
              issue_number: prNumber, 
              body 
            });