name: Agent – Open PR and Ping

on:
  workflow_call:
    inputs:
      pr_title:
        required: true
        type: string
      pr_body:
        required: false
        type: string
        default: ""
      prompt:
        required: true
        type: string
      base_branch:
        required: false
        type: string
        default: "main"
      author_name:
        required: false
        type: string
        default: "henrylkirk"         # e.g., "Your Name"
      author_email:
        required: false
        type: string
        default: "henry@the-kirks.com"         # e.g., "you@example.com" or "username@users.noreply.github.com"
      agent:
        required: false
        type: string
        default: "copilot"  # Copilot or Codex
    outputs:
      pr_number:
        value: ${{ jobs.open_and_ping.outputs.pr_number }}
      branch:
        value: ${{ jobs.open_and_ping.outputs.branch }}

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  open_and_ping:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ fromJSON(steps.pr.outputs.result).number }}
      branch: ${{ env.BRANCH_NAME }}
    env:
      BASE_BRANCH: ${{ inputs.base_branch }}
      AGENT: ${{ inputs.agent }}
      BRANCH_NAME: ${{ format('{0}/task-{1}-{2}', inputs.agent, github.run_id, github.run_attempt) }}

    steps:
      - name: Validate GH_USER_TOKEN
        run: |
          set -e
          test -n "${GH_USER_TOKEN}" || { echo "GH_USER_TOKEN is empty"; exit 1; }
          code=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${GH_USER_TOKEN}" https://api.github.com/user)
          if [ "$code" != "200" ]; then
            echo "Token cannot access /user (HTTP $code). Check scopes, repo access, and SSO."; exit 1;
          fi
        env:
          GH_USER_TOKEN: ${{ secrets.GH_USER_TOKEN }}

      - name: Checkout (with your token so pushes are yours)
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base_branch }}
          fetch-depth: 0
          token: ${{ secrets.GH_USER_TOKEN }}

      - name: Create empty commit on new branch (from latest base)
        run: |
          # Prefer user-provided identity; otherwise leave Git defaults (will still push with your PAT)
          if [ -n "${AUTHOR_NAME}" ]; then git config user.name  "${AUTHOR_NAME}"; fi
          if [ -n "${AUTHOR_EMAIL}" ]; then git config user.email "${AUTHOR_EMAIL}"; fi

          git fetch origin "$BASE_BRANCH"
          git switch -c "$BRANCH_NAME" "origin/$BASE_BRANCH"

          git commit --allow-empty -m "${{ inputs.pr_title }}"
          git push -u origin "$BRANCH_NAME"
        env:
          BASE_BRANCH: ${{ inputs.base_branch }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
          AUTHOR_NAME: ${{ inputs.author_name }}
          AUTHOR_EMAIL: ${{ inputs.author_email }}

      - name: Validate agent selection
        run: |
          set -euo pipefail
          agent_lower=${AGENT,,}
          if [ "$agent_lower" != "copilot" ] && [ "$agent_lower" != "codex" ] && [ "$agent_lower" != "agent" ]; then
            echo "Unsupported agent value: $AGENT" >&2
            exit 1
          fi
        env:
          AGENT: ${{ env.AGENT }}

      - name: Open PR (authored by your user)
        id: pr
        uses: actions/github-script@v7
        env:
          PR_TITLE: ${{ inputs.pr_title }}
          PR_BODY: ${{ inputs.pr_body }}
          PROMPT: ${{ inputs.prompt }}
          BASE_BRANCH: ${{ inputs.base_branch }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
        with:
          github-token: ${{ secrets.GH_USER_TOKEN }}
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              title: process.env.PR_TITLE,
              head:  process.env.BRANCH_NAME,
              base:  process.env.BASE_BRANCH,
              body:  process.env.PR_BODY || undefined,
              maintainer_can_modify: true,
            });
            return {
              number: pr.number,
              head_sha: pr.head.sha,
            };

      - name: (Optional) Label the PR (as your user)
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: ${{ fromJSON(steps.pr.outputs.result).number }}
          AGENT: ${{ env.AGENT }}
        with:
          github-token: ${{ secrets.GH_USER_TOKEN }}
          script: |
            try {
              const agent = (process.env.AGENT || 'copilot').toLowerCase();
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: Number(process.env.ISSUE_NUMBER),
                labels: [agent],
              });
            } catch (e) {
              core.info('Label add skipped: ' + e.message);
            }

      - name: Comment to trigger AI agent (as your user)
        uses: actions/github-script@v7
        env:
          BASE_BRANCH: ${{ inputs.base_branch }}
          PROMPT: ${{ inputs.prompt }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
          PR_NUMBER: ${{ fromJSON(steps.pr.outputs.result).number }}
          HEAD_SHA: ${{ fromJSON(steps.pr.outputs.result).head_sha }}
          AGENT: ${{ env.AGENT }}
        with:
          github-token: ${{ secrets.GH_USER_TOKEN }}
          script: |
            const prNumber = Number(process.env.PR_NUMBER);
            const owner  = context.repo.owner;
            const repo   = context.repo.repo;
            const branch = process.env.BRANCH_NAME;
            const agent = (process.env.AGENT || 'copilot').toLowerCase();
            const mention = agent === 'codex' ? '@codex' : agent === 'agent' ? '@agent' : '@copilot';

            const preInstruction = "Begin by surveying the entire codebase before narrowing to this task.";
            const postInstruction = "Ensure changes are self-contained, tested, and documented as needed, with no reduction in test coverage. Ensure the diff is minimal, readable, and well-commented; never sacrifice clarity for cleverness. There is no time constraint or specific allotted time for this task; prioritize quality and correctness over speed and take as much time as needed. You may **NOT** respond with \"no issues found\", \"didn't find any major issues\", or similar—if no obvious implementation exists, choose the most plausible area and apply a singular, safe, minimal improvement.";
            const lines = [
              `${mention} ${preInstruction} ${process.env.PROMPT} ${postInstruction}`,
              ""
            ];

            if (agent === 'agent') {
              lines.push(
                `Once done, ensure all changes are pushed to remote branch **${branch}** on base **${process.env.BASE_BRANCH}** and keep all commits tied to PR #${prNumber}; do not open new branches or PRs. As the final step (even after running 'make_pr'), run the following exact command(s) to guarantee your changes are pushed:`,
                "",
                "```bash",
                `git config user.name "bot"`,
                `git config user.email "bot@example.com"`,
                `git -c credential.helper= \\`,
                `    -c 'credential.helper=store --file .git/codex-cred' \\`,
                `    push "https://henrylkirk@github.com/${owner}/${repo}.git" "HEAD:${branch}"`,
                "```",
                ""
              );
            }

            lines.push(
              "Here is some additional context for your task:",
              "```yaml",
              "task_context:",
              `  branch: "${branch}"`,
              `  pr_number: ${prNumber}`,
              `  base: "${process.env.BASE_BRANCH}"`,
              `  head_sha: "${process.env.HEAD_SHA}"`,
              "```"
            );

            const body = lines.join("\n");

            await github.rest.issues.createComment({ 
              owner, 
              repo, 
              issue_number: prNumber, 
              body 
            });