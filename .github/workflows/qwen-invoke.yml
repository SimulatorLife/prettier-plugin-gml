name: '▶️ Qwen Invoke'

on:
  issue_comment:
    types: [created]

concurrency:
  group: '${{ github.workflow }}-invoke-${{ github.event_name }}-${{ github.event.issue.number }}'
  cancel-in-progress: false

defaults:
  run:
    shell: 'bash'

jobs:
  prepare:
    if: ${{ github.event.issue.pull_request && contains(github.event.comment.body || '', '@qwen') }}
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ github.event.issue.number }}
      additional_context: ${{ github.event.comment.body }}
      api_key: ${{ secrets.DASHSCOPE_API_KEY }}

  invoke:
    needs: prepare
    uses: ./.github/workflows/agent-invoke.yml
    secrets: inherit
    with:
      pr_number: ${{ needs.prepare.outputs.pr_number }}
      additional_context: ${{ needs.prepare.outputs.additional_context }}
      api_key: ${{ needs.prepare.outputs.api_key }}
      agent: qwen
      npm_package: '@qwen/cli@latest'
      agent_command: |
        set -euo pipefail
        qwen --openai-api-key "${API_KEY}" "${ADDITIONAL_CONTEXT}"