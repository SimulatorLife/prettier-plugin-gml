name: '▶️ Qwen Invoke'

on:
  issue_comment:
    types: [created]

concurrency:
  group: '${{ github.workflow }}-invoke-${{ github.event_name }}-${{ github.event.issue.number }}'
  cancel-in-progress: false

defaults:
  run:
    shell: 'bash'

jobs:
  invoke:
    if: ${{ github.event.issue.pull_request && startsWith(github.event.comment.body || '', '@qwen') }}
    uses: ./.github/workflows/agent-invoke.yml
    secrets:
      api_key: ${{ secrets.OPENROUTER_API_KEY }}
    with:
      pr_number: ${{ github.event.issue.number }}
      additional_context: ${{ github.event.comment.body }}
      agent: qwen
      npm_package: '@qwen-code/qwen-code@latest'
      agent_command: |
        set -euo pipefail
        # Resolve API key
        if [ -z "${API_KEY:-}" ]; then
          echo "❌ Missing API_KEY!"
          exit 1
        fi
        
        # export OPENAI_BASE_URL="https://dashscope.aliyuncs.com/compatible-mode/v1"
        # export OPENAI_MODEL="qwen3-coder-plus"

        export OPENAI_API_KEY="${API_KEY}"
        export OPENAI_BASE_URL="https://openrouter.ai/api/v1"
        export OPENAI_MODEL="qwen/qwen3-coder:free"

        qwen --yolo --openai-api-key "${OPENAI_API_KEY}" --openai-base-url="${OPENAI_BASE_URL}" --model="${OPENAI_MODEL}" --prompt "${ADDITIONAL_CONTEXT}"